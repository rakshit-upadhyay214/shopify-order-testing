{
    "info": {
        "name": "Order Creation",
        "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
    },
    "item": [
        {
            "name": "CreateOrder",
            "event": [
                {
                    "listen": "prerequest",
                    "script": {
                        "exec": [
                            "// Stringify lineItems so they can be safely injected into the GraphQL variables string",
                            "const lineItems = pm.iterationData.get('lineItems');",
                            "              ",
                            "// Helper to check if we have new scenario fields",
                            "const isNewScenario = pm.iterationData.has('shippingLines') || pm.iterationData.has('taxesIncluded');",
                            "",
                            "// Filter lineItems to match OrderCreateLineItemInput structure",
                            "const graphqlLineItems = lineItems.map(item => {",
                            "    const lineItemInput = {",
                            "        variantId: item.variantId,",
                            "        quantity: item.quantity",
                            "    };",
                            "",
                            "    // Handle Applied Discounts (Net Price Calculation)",
                            "    // OrderCreateLineItemInput does not support appliedDiscounts directly.",
                            "    // We simulate it by reducing the price.",
                            "    let originalPrice = item.price || 0;",
                            "    if (item.appliedDiscounts && item.appliedDiscounts.length > 0) {",
                            "        const totalDiscount = item.appliedDiscounts.reduce((sum, discount) => sum + (discount.amount || 0), 0);",
                            "        // Ensure price doesn't go negative",
                            "        const netPrice = Math.max(0, originalPrice - (totalDiscount / item.quantity)); ",
                            "        // Note: validation of amount distribution is simplified here. ",
                            "        // Ideally, we'd use a draft order for perfect fidelity, but for orderCreate, we adjust the unit price.",
                            "        lineItemInput.priceSet = {",
                            "            shopMoney: {",
                            "                amount: netPrice.toFixed(2),",
                            "                currencyCode: \"USD\"",
                            "            }",
                            "        };",
                            "    } else if (item.price) {",
                            "         // Backward compatibility: explicit price if set",
                            "         // If not set, Shopify uses variant price. ",
                            "         // Check if we need to explicitly set it to override something or just let it be.",
                            "         // Previous script didn't set priceSet, relying on Shopify defaults or it was just filtered out.",
                            "         // But if we want to support \"price\" override from JSON:",
                            "         lineItemInput.priceSet = {",
                            "            shopMoney: {",
                            "                amount: item.price.toFixed(2),",
                            "                currencyCode: \"USD\"",
                            "            }",
                            "         };",
                            "    }",
                            "",
                            "    // Handle Tax Lines",
                            "    if (item.taxLines && item.taxLines.length > 0) {",
                            "        lineItemInput.taxLines = item.taxLines.map(tax => ({",
                            "            title: tax.title,",
                            "            rate: tax.rate,",
                            "            priceSet: {",
                            "                shopMoney: {",
                            "                    amount: tax.price.toFixed(2),",
                            "                    currencyCode: \"USD\"",
                            "                }",
                            "            }",
                            "        }));",
                            "    }",
                            "    ",
                            "    return lineItemInput;",
                            "});",
                            "",
                            "pm.variables.set(\"lineItemsString\", JSON.stringify(graphqlLineItems));",
                            "",
                            "// 1. Get Tax and Discount Data",
                            "const taxLines = pm.iterationData.get('taxLines');",
                            "const discountCode = pm.iterationData.get('discountCode');",
                            "",
                            "// Calculate total for Transaction",
                            "// Note: This is an approximation. Real total depends on tax settings (included vs excluded) and shipping.",
                            "// For sync scenarios, we trust the `totalAmount` if provided, calc includes Taxes and Discounts.",
                            "let totalAmount = 0;",
                            "let subtotal = 0;",
                            "",
                            "lineItems.forEach(item => {",
                            "    let itemPrice = item.price || 0;",
                            "    // If we adjusted price for discount, use that",
                            "    if (item.appliedDiscounts) {",
                            "         const totalDiscount = item.appliedDiscounts.reduce((sum, d) => sum + (d.amount || 0), 0);",
                            "         itemPrice = Math.max(0, itemPrice - (totalDiscount / item.quantity));",
                            "    }",
                            "    ",
                            "    const lineBase = itemPrice * item.quantity;",
                            "    subtotal += lineBase;",
                            "",
                            "    let lineTotal = lineBase;",
                            "    ",
                            "    // Add line item taxes if present",
                            "    if (item.taxLines) {",
                            "        item.taxLines.forEach(t => {",
                            "            lineTotal += (t.price || 0);",
                            "        });",
                            "    }",
                            "    ",
                            "    totalAmount += lineTotal;",
                            "});",
                            "",
                            "// Add Shipping Cost and Taxes to Transaction Amount",
                            " const shippingLines = pm.iterationData.get('shippingLines');",
                            "let shippingComponent = [];",
                            "let shippingCost = 0;",
                            "if (shippingLines && shippingLines.length > 0) {",
                            "    shippingLines.forEach(shipping => {",
                            "        let price = shipping.price || 0;",
                            "        shippingCost += price;",
                            "        totalAmount += price;",
                            "        ",
                            "        shippingComponent.push({",
                            "            title: shipping.title,",
                            "            priceSet: {",
                            "                shopMoney: {",
                            "                    amount: price.toFixed(2),",
                            "                    currencyCode: \"USD\"",
                            "                }",
                            "            },",
                            "            code: shipping.code",
                            "        });",
                            "    });",
                            "}",
                            "",
                            "// Add Order Level Taxes",
                            "if (taxLines && taxLines.length > 0) {",
                            "    taxLines.forEach(tax => {",
                            "        totalAmount += (tax.price || 0);",
                            "    });",
                            "}",
                            "",
                            "// Subtract Order Level Discount",
                            "if (discountCode) {",
                            "    let discountAmount = 0;",
                            "    if (discountCode.type === 'fixed_amount') {",
                            "        discountAmount = parseFloat(discountCode.amount || 0);",
                            "    } else if (discountCode.type === 'percentage') {",
                            "         // Apply percentage to subtotal",
                            "        let percentage = parseFloat(discountCode.amount || discountCode.percentage || 0);",
                            "        discountAmount = subtotal * (percentage / 100.0);",
                            "    } else if (discountCode.type === 'free_shipping') {",
                            "        discountAmount = shippingCost;",
                            "    }",
                            "    ",
                            "    totalAmount -= discountAmount;",
                            "    totalAmount = Math.max(0, totalAmount);",
                            "}",
                            "              ",
                            "const transactions = [{",
                            "    kind: \"SALE\",",
                            "    status: \"SUCCESS\",",
                            "    amountSet: {",
                            "        shopMoney: {",
                            "            amount: totalAmount.toFixed(2),",
                            "            currencyCode: \"USD\"",
                            "        }",
                            "    }",
                            "}];",
                            "              ",
                            "const orderInput = {",
                            "    customer: {",
                            "        toAssociate: {",
                            "            id: pm.iterationData.get('customerId') || 'gid://shopify/Customer/7275629314092' // Fallback for backward compatibility",
                            "        }",
                            "    },",
                            "    lineItems: graphqlLineItems,",
                            "    transactions: transactions,",
                            "    shippingAddress: pm.iterationData.get('shippingAddress') || null,",
                            "    billingAddress: pm.iterationData.get('billingAddress') || null,",
                            "    tags: pm.iterationData.get('tags') || [],",
                            "    taxesIncluded: pm.iterationData.get('taxesIncluded') || false",
                            "};",
                            "",
                            "if (shippingComponent.length > 0) {",
                            "    orderInput.shippingLines = shippingComponent;",
                            "}",
                            "",
                            "// Handle Order Level Tax Lines (Mapping)",
                            "if (taxLines && taxLines.length > 0) {",
                            "    orderInput.taxLines = taxLines.map(tax => ({",
                            "        title: tax.title,",
                            "        rate: tax.rate,",
                            "        priceSet: {",
                            "            shopMoney: {",
                            "                amount: tax.price.toFixed(2),",
                            "                currencyCode: \"USD\"",
                            "            }",
                            "        }",
                            "    }));",
                            "}",
                            "",
                            "// Handle Discount Code (Mapping)",
                            "if (discountCode) {",
                            "    // Map scenario 'discountCode' to OrderCreateDiscountCodeInput",
                            "    orderInput.discountCode = {};",
                            "    ",
                            "    if (discountCode.type === 'percentage') {",
                            "        orderInput.discountCode.itemPercentageDiscountCode = {",
                            "            code: discountCode.code,",
                            "            percentage: parseFloat(discountCode.amount || discountCode.percentage)",
                            "        };",
                            "    } else if (discountCode.type === 'fixed_amount') {",
                            "         orderInput.discountCode.itemFixedDiscountCode = {",
                            "            code: discountCode.code,",
                            "            amountSet: {",
                            "                shopMoney: {",
                            "                    amount: parseFloat(discountCode.amount).toFixed(2),",
                            "                    currencyCode: \"USD\"",
                            "                }",
                            "            }",
                            "        };",
                            "    } else if (discountCode.type === 'free_shipping') {",
                            "        orderInput.discountCode.freeShippingDiscountCode = {",
                            "            code: discountCode.code",
                            "        };",
                            "    }",
                            "}",
                            "",
                            "pm.variables.set('orderInput', JSON.stringify(orderInput));"
                        ],
                        "type": "text/javascript"
                    }
                },
                {
                    "listen": "test",
                    "script": {
                        "exec": [
                            "const response = pm.response.json();",
                            "if (response.data && response.data.orderCreate && response.data.orderCreate.order) {",
                            "    const order = response.data.orderCreate.order;",
                            "    pm.environment.set(\"orderId\", order.id);",
                            "    console.log('[Automation] Order Created:', order.id);",
                            "",
                            "    // Store line item mapping: variantId -> { lineItemId, price }",
                            "    const mapping = {};",
                            "    if (order.lineItems && order.lineItems.nodes) {",
                            "        order.lineItems.nodes.forEach(item => {",
                            "            if (item.variant && item.variant.id) {",
                            "                mapping[item.variant.id] = {",
                            "                    id: item.id,",
                            "                    price: parseFloat(item.originalUnitPriceSet.shopMoney.amount)",
                            "                };",
                            "            }",
                            "        });",
                            "    }",
                            "    pm.environment.set(\"lineItemMapping\", JSON.stringify(mapping));",
                            "} else {",
                            "    const errors = response.data && response.data.orderCreate ? response.data.orderCreate.userErrors : response;",
                            "    console.error('[Automation] Order Creation Failed:', JSON.stringify(errors));",
                            "}"
                        ],
                        "type": "text/javascript"
                    }
                }
            ],
            "id": "8423fbd0-be76-4a9a-816d-ba9aa1885959",
            "request": {
                "method": "POST",
                "header": [
                    {
                        "key": "X-Shopify-Access-Token",
                        "value": "{{accessToken}}",
                        "type": "text"
                    }
                ],
                "body": {
                    "mode": "graphql",
                    "graphql": {
                        "query": "mutation CreateOrder($order: OrderCreateOrderInput!) {\n  orderCreate(order: $order) { __typename \n    userErrors { __typename \n      field\n      message\n    }\n    order {\n      id\n      name\n      lineItems(first: 10) { __typename \n        nodes { __typename \n          id\n          title\n          quantity\n          variant { __typename \n            id\n          }\n          originalUnitPriceSet { __typename \n            shopMoney { __typename \n              amount\n            }\n          }\n        }\n      }\n    }\n  }\n}",
                        "variables": "{\n  \"order\": {{orderInput}}\n}"
                    }
                },
                "url": {
                    "raw": "https://{{shopName}}.myshopify.com/admin/api/{{apiVersion}}/graphql.json",
                    "protocol": "https",
                    "host": [
                        "{{shopName}}",
                        "myshopify",
                        "com"
                    ],
                    "path": [
                        "admin",
                        "api",
                        "{{apiVersion}}",
                        "graphql.json"
                    ]
                }
            }
        }
    ]
}